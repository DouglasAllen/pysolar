#    Copyright Brandon Stafford
#
#    This file is part of Pysolar.
#
#    Pysolar is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 3 of the License, or
#    (at your option) any later version.
#
#    Pysolar is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License along
#    with Pysolar. If not, see <http://www.gnu.org/licenses/>.

"""
This file is consists of numerical constants for calculating corrections,
such as the wiggling ("nutation") of the axis of the earth. It also includes
functions for building dictionaries of polynomial functions for rapid
calculation of corrections.

Most of the constants come from a 2005 paper by Reda and Andreas:

I. Reda and A. Andreas, "Solar Position Algorithm for Solar Radiation
Applications," National Renewable Energy Laboratory, NREL/TP-560-34302,
revised November 2005.

http://www.osti.gov/bridge/servlets/purl/15003974-iP3z6k/native/15003974.PDF

However, it seems that Reda and Andreas took the bulk of the constants
(L0, etc.) from Pierre Bretagnon and Gerard Francou's Variations Seculaires
des Orbites Planetaires, or VSOP87:

http://en.wikipedia.org/wiki/Secular_variations_of_the_planetary_orbits#VSOP87

See also ftp://ftp.imcce.fr/pub/ephem/planets/vsop87/VSOP87D.ear
"""

# ABERRATION_COEFFS = None

def aberration_coeffs(nutation_coeffs=None):
    """
    This function builds a dictionary of polynomial functions from a list of
    coefficients, so that the functions can be called by name. This is used in
    calculating nutation.
    see: http://aa.usno.navy.mil/publications/docs/Circular_179.pdf
    """

    # global ABERRATION_COEFFS
    if nutation_coeffs is None:
        nutation_coeffs = dict \
          (
              (name, (
                  lambda a, b, c, d, e:
                  lambda x: (((e * x + d) * x + c) * x + b) * x + a)(*coeffs))
              for name, coeffs in
              (
                  ('MeanAnomalyOfMoon',
                   (134.96340251, 477198.8675605, 0.008855333, 1.43430556e-05, -6.797222e-08)),
                  ('MeanAnomalyOfSun',
                   (357.52911, 35999.05029, -0.0001537, 3.778e-08, -3.191667e-09)),
                  ('ArgumentOfLatitudeOfMoon',
                   (93.272091, 483202.0174577, -0.003542, -2.880555e-07, 1.158333e-09)),
                  ('MeanElongationOfMoon',
                   (297.8501955, 445267.1114469445, -0.0017696, 1.831389e-06, 8.802778e-09)),
                  ('LongitudeOfAscendingNode',
                   (125.044555, -1934.136262, 0.0020756, 2.139444e-06, 1.649722e-08))
              )
          )
    #end if
    return nutation_coeffs
#end get_aberration_coeffs

EARTH_RADIUS = 6378140.0 # meters
EARTH_AXIS_INCLINATION = 23.45 # degrees
SECONDS_PER_DAY = 86400

STANDARD_PRESSURE = 101325.00 # pascals
STANDARD_TEMPERATURE = 288.15 # kelvin
CELSIUS_OFFSET = 273.15 # subtract from kelvin to get deg C, add to deg C to get kelvin
EARTH_TEMPERATURE_LAPSE_RATE = -0.0065 # change in temperature with height, kelvin/metre
AIR_GAS_CONSTANT = 8.31432 # N*m/s^2
EARTH_GRAVITY = 9.80665 # m/s^2 or N/kg
EARTH_ATMOSPHERE_MOLAR_MASS = 0.0289644 # kg/mol

# Fundamental Argument Multipliers
FAM = \
    [
        [0, 0, 0, 0, 1],
        [0, 0, 2, -2, 2],
        [0, 0, 2, 0, 2],
        [0, 0, 0, 0, 2],
        [0, 1, 0, 0, 0],
        [0, 1, 2, -2, 2],
        [1, 0, 0, 0, 0],
        [0, 0, 2, 0, 1],
        [1, 0, 2, 0, 2],
        [0, -1, 2, -2, 2],
        [0, 0, 2, -2, 1],
        [-1, 0, 2, 0, 2],
        [-1, 0, 0, 2, 0],
        [1, 0, 0, 0, 1],
        [-1, 0, 0, 0, 1],
        [-1, 0, 2, 2, 2],
        [1, 0, 2, 0, 1],
        [-2, 0, 2, 0, 1],
        [0, 0, 0, 2, 0],
        [0, 0, 2, 2, 2],
        [0, -2, 2, -2, 2],
        [-2, 0, 0, 2, 0],
        [2, 0, 2, 0, 2],
        [1, 0, 2, -2, 2],
        [-1, 0, 2, 0, 1],
        [2, 0, 0, 0, 0],
        [0, 0, 2, 0, 0],
        [0, 1, 0, 0, 1],
        [-1, 0, 0, 2, 1],
        [0, 2, 2, -2, 2],
        [0, 0, -2, 2, 0],
        [1, 0, 0, -2, 1],
        [0, -1, 0, 0, 1],
        [-1, 0, 2, 2, 1],
        [0, 2, 0, 0, 0],
        [1, 0, 2, 2, 2],
        [-2, 0, 2, 0, 0],
        [0, 1, 2, 0, 2],
        [0, 0, 2, 2, 1],
        [0, -1, 2, 0, 2],
        [0, 0, 0, 2, 1],
        [1, 0, 2, -2, 1],
        [2, 0, 2, -2, 2],
        [-2, 0, 0, 2, 1],
        [2, 0, 2, 0, 1],
        [0, -1, 2, -2, 1],
        [0, 0, 0, -2, 1],
        [-1, -1, 0, 2, 0],
        [2, 0, 0, -2, 1],
        [1, 0, 0, 2, 0],
        [0, 1, 2, -2, 1],
        [1, -1, 0, 0, 0],
        [-2, 0, 2, 0, 2],
        [3, 0, 2, 0, 2],
        [0, -1, 0, 2, 0],
        [1, -1, 2, 0, 2],
        [0, 0, 0, 1, 0],
        [-1, -1, 2, 2, 2],
        [-1, 0, 2, 0, 0],
        [0, -1, 2, 2, 2],
        [-2, 0, 0, 0, 1],
        [1, 1, 2, 0, 2],
        [2, 0, 0, 0, 1],
        [-1, 1, 0, 1, 0],
        [1, 1, 0, 0, 0],
        [1, 0, 2, 0, 0],
        [-1, 0, 2, -2, 1],
        [1, 0, 0, 0, 2]
    ]

NUTATION_COEFFICIENTS = \
    [
        [-171996, -174.2, 92025, 8.9],
        [-13187, -1.6, 5736, -3.1],
        [-2274, -0.2, 977, -0.5],
        [2062, 0.2, -895, 0.5],
        [1426, -3.4, 54, -0.1],
        [712, 0.1, -7, 0],
        [-517, 1.2, 224, -0.6],
        [-386, -0.4, 200, 0],
        [-301, 0, 129, -0.1],
        [217, -0.5, -95, 0.3],
        [-158, 0, 0, 0],
        [129, 0.1, -70, 0],
        [123, 0, -53, 0],
        [63, 0, 0, 0],
        [63, 0.1, -33, 0],
        [-59, 0, 26, 0],
        [-58, -0.1, 32, 0],
        [-51, 0, 27, 0],
        [48, 0, 0, 0],
        [46, 0, -24, 0],
        [-38, 0, 16, 0],
        [-31, 0, 13, 0],
        [29, 0, 0, 0],
        [29, 0, -12, 0],
        [26, 0, 0, 0],
        [-22, 0, 0, 0],
        [21, 0, -10, 0],
        [17, -0.1, 0, 0],
        [16, 0, -8, 0],
        [-16, 0.1, 7, 0],
        [-15, 0, 9, 0],
        [-13, 0, 7, 0],
        [-12, 0, 6, 0],
        [11, 0, 0, 0],
        [-10, 0, 5, 0],
        [-8, 0, 3, 0],
        [7, 0, -3, 0],
        [-7, 0, 0, 0],
        [-7, 0, 3, 0],
        [-7, 0, 3, 0],
        [6, 0, 0, 0],
        [6, 0, -3, 0],
        [6, 0, -3, 0],
        [-6, 0, 3, 0],
        [-6, 0, 3, 0],
        [5, 0, 0, 0],
        [-5, 0, 3, 0],
        [-5, 0, 3, 0],
        [-5, 0, 3, 0],
        [4, 0, 0, 0],
        [4, 0, 0, 0],
        [4, 0, 0, 0],
        [-4, 0, 0, 0],
        [-4, 0, 0, 0],
        [-4, 0, 0, 0],
        [3, 0, 0, 0],
        [-3, 0, 0, 0],
        [-3, 0, 0, 0],
        [-3, 0, 0, 0],
        [-3, 0, 0, 0],
        [-3, 0, 0, 0],
        [-3, 0, 0, 0],
        [-3, 0, 0, 0],
    ]

# L
HELIOCENTRIC_LONGITUDE_COEFFS = \
(
    (# 64 of 559
        (1.75347045673, 0.00000000000, 0.00000000000), # 1
        (0.03341656456, 4.66925680417, 6283.07584999140), # 2
        (0.00034894275, 4.62610241759, 12566.15169998280), # 3
        (0.00003417571, 2.82886579606, 3.52311834900), # 4
        (0.00003497056, 2.74411800971, 5753.38488489680), # 5
        (0.00003135896, 3.62767041758, 77713.77146812050), # 6
        (0.00002676218, 4.41808351397, 7860.41939243920), # 7
        (0.00002342687, 6.13516237631, 3930.20969621960), # 8
        (0.00001273166, 2.03709655772, 529.69096509460), # 9
        (0.00001324292, 0.74246356352, 11506.76976979360), # 10
        (0.00000901855, 2.04505443513, 26.29831979980), # 11
        (0.00001199167, 1.10962944315, 1577.34354244780), # 12
        (0.00000857223, 3.50849156957, 398.14900340820), # 13
        (0.00000779786, 1.17882652114, 5223.69391980220), # 14
        (0.00000990250, 5.23268129594, 5884.92684658320), # 15
        (0.00000753141, 2.53339053818, 5507.55323866740), # 16
        (0.00000505264, 4.58292563052, 18849.22754997420), # 17
        (0.00000492379, 4.20506639861, 775.52261132400), # 18
        (0.00000356655, 2.91954116867, 0.06731030280), # 19
        (0.00000284125, 1.89869034186, 796.29800681640), # 20
        (0.00000242810, 0.34481140906, 5486.77784317500), # 21
        (0.00000317087, 5.84901952218, 11790.62908865880), # 22
        (0.00000271039, 0.31488607649, 10977.07880469900), # 23
        (0.00000206160, 4.80646606059, 2544.31441988340), # 24
        (0.00000205385, 1.86947813692, 5573.14280143310), # 25
        (0.00000202261, 2.45767795458, 6069.77675455340), # 26
        (0.00000126184, 1.08302630210, 20.77539549240), # 27
        (0.00000155516, 0.83306073807, 213.29909543800), # 28
        (0.00000115132, 0.64544911683, 0.98032106820), # 29
        (0.00000102851, 0.63599846727, 4694.00295470760), # 30
        (0.00000101724, 4.26679821365, 7.11354700080), # 31
        (0.00000099206, 6.20992940258, 2146.16541647520), # 32
        (0.00000132212, 3.41118275555, 2942.46342329160), # 33
        (0.00000097607, 0.68101272270, 155.42039943420), # 34
        (0.00000085128, 1.29870743025, 6275.96230299060), # 35
        (0.00000074651, 1.75508916159, 5088.62883976680), # 36
        (0.00000101895, 0.97569221824, 15720.83878487840), # 37
        (0.00000084711, 3.67080093025, 71430.69561812909), # 38
        (0.00000073547, 4.67926565481, 801.82093112380), # 39
        (0.00000073874, 3.50319443167, 3154.68708489560), # 40
        (0.00000078756, 3.03698313141, 12036.46073488820), # 41
        (0.00000079637, 1.80791330700, 17260.15465469040), # 42
        (0.00000085803, 5.98322631256, 161000.68573767410), # 43
        (0.00000056963, 2.78430398043, 6286.59896834040), # 44
        (0.00000061148, 1.81839811024, 7084.89678111520), # 45
        (0.00000069627, 0.83297596966, 9437.76293488700), # 46
        (0.00000056116, 4.38694880779, 14143.49524243060), # 47
        (0.00000062449, 3.97763880587, 8827.39026987480), # 48
        (0.00000051145, 0.28306864501, 5856.47765911540), # 49
        (0.00000055577, 3.47006009062, 6279.55273164240), # 50
        (0.00000041036, 5.36817351402, 8429.24126646660), # 51
        (0.00000051605, 1.33282746983, 1748.01641306700), # 52
        (0.00000051992, 0.18914945834, 12139.55350910680), # 53
        (0.00000049000, 0.48735065033, 1194.44701022460), # 54
        (0.00000039200, 6.16832995016, 10447.38783960440), # 55
        (0.00000035566, 1.77597314691, 6812.76681508600), # 56
        (0.00000036770, 6.04133859347, 10213.28554621100), # 57
        (0.00000036596, 2.56955238628, 1059.38193018920), # 58
        (0.00000033291, 0.59309499459, 17789.84561978500), # 59
        (0.00000035954, 1.70876111898, 2352.86615377180), # 60
        (0.00000040938, 2.39850881707, 19651.04848109800), # 61
        (0.00000036770, 6.04133859347, 10213.28554621100), # 62
        (0.00000030412, 0.44294464135, 83996.84731811189), # 63
        (0.00000023663, 0.48473567763, 8031.09226305840), # 64
    ), #
    # 34 of 341
    (
        (6283.31966747491, 0.00000000000, 0.00000000000), # 1
        (0.00206058863, 2.67823455584, 6283.07584999140), # 2
        (0.00004303430, 2.63512650414, 12566.15169998280), # 3
        (0.00000425264, 1.59046980729, 3.52311834900), # 4
        (0.00000108977, 2.96618001993, 1577.34354244780), # 5
        (0.00000093478, 2.59212835365, 18849.22754997420), # 6
        (0.00000119261, 5.79557487799, 26.29831979980), # 7
        (0.00000072122, 1.13846158196, 529.69096509460), # 8
        (0.00000067768, 1.87472304791, 398.14900340820), # 9
        (0.00000067327, 4.40918235168, 5507.55323866740), # 10
        (0.00000059027, 2.88797038460, 5223.69391980220), # 11
        (0.00000055976, 2.17471680261, 155.42039943420), # 12
        (0.00000045407, 0.39803079805, 796.29800681640), # 13
        (0.00000036369, 0.46624739835, 775.52261132400), # 14
        (0.00000028958, 2.64707383882, 7.11354700080), # 15
        (0.00000019097, 1.84628332577, 5486.77784317500), # 16
        (0.00000020844, 5.34138275149, 0.98032106820), # 17
        (0.00000018508, 4.96855124577, 213.29909543800), # 18
        (0.00000016233, 0.03216483047, 2544.31441988340), # 19
        (0.00000017293, 2.99116864949, 6275.96230299060), # 20
        (0.00000015832, 1.43049285325, 2146.16541647520), # 21
        (0.00000014615, 1.20532366323, 10977.07880469900), # 22
        (0.00000011877, 3.25804815607, 5088.62883976680), # 23
        (0.00000011514, 2.07502418155, 4694.00295470760), # 34
        (0.00000009721, 4.23925472239, 1349.86740965880), # 25
        (0.00000009969, 1.30262991097, 6286.59896834040), # 26
        (0.00000009452, 2.69957062864, 242.72860397400), # 27
        (0.00000012461, 2.83432285512, 1748.01641306700), # 28
        (0.00000011808, 5.27379790480, 1194.44701022460), # 29
        (0.00000008577, 5.64475868067, 951.71840625060), # 30
        (0.00000010641, 0.76614199202, 553.56940284240), # 31
        (0.00000007576, 5.30062664886, 2352.86615377180), # 32
        (0.00000005834, 1.76649917904, 1059.38193018920), # 33
        (0.00000006385, 2.65033984967, 9437.76293488700), # 34
    ),
    # 20 of 142
    (
        (0.00052918870, 0.00000000000, 0.00000000000), # 1
        (0.00008719837, 1.07209665242, 6283.07584999140), # 2
        (0.00000309125, 0.86728818832, 12566.15169998280), # 3
        (0.00000027339, 0.05297871691, 3.52311834900), # 4
        (0.00000016334, 5.18826691036, 26.29831979980), # 5
        (0.00000015752, 3.68457889430, 155.42039943420), # 6
        (0.00000009541, 0.75742297675, 18849.22754997420), # 7
        (0.00000008937, 2.05705419118, 77713.77146812050), # 8
        (0.00000008937, 2.05705419118, 77713.77146812050), # 9
        (0.00000005064, 4.66284525271, 1577.34354244780), # 10
        (0.00000004061, 1.03057162962, 7.11354700080), # 11
        (0.00000003463, 5.14074632811, 796.29800681640), # 12
        (0.00000003169, 6.05291851171, 5507.55323866740), # 13
        (0.00000003020, 1.19246506441, 242.72860397400), # 14
        (0.00000002886, 6.11652627155, 529.69096509460), # 15
        (0.00000003810, 3.44050803490, 5573.14280143310), # 16
        (0.00000002714, 0.30637881025, 398.14900340820), # 17
        (0.00000002371, 4.38118838167, 5223.69391980220), # 18
        (0.00000002538, 2.27992810679, 553.56940284240), # 19
        (0.00000002079, 3.75435330484, 0.98032106820), # 20
    ),
    # 10 of 22
    (
        (0.00000289226, 5.84384198723, 6283.07584999140),
        (0.00000034955, 0.00000000000, 0.00000000000),
        (0.00000016819, 5.48766912348, 12566.15169998280),
        (0.00000002962, 5.19577265202, 155.42039943420),
        (0.00000001288, 4.72200252235, 3.52311834900),
        (0.00000000635, 5.96925937141, 242.72860397400),
        (0.00000000714, 5.30045809128, 18849.22754997420),
        (0.00000000402, 3.78682982419, 553.56940284240),
        (0.00000000072, 4.29768126180, 6286.59896834040),
        (0.00000000067, 0.90721687647, 6127.65545055720),
    ),
    # all 11
    (
        (0.00000114084, 3.14159265359, 0.00000000000),
        (0.00000007717, 4.13446589358, 6283.07584999140),
        (0.00000000765, 3.83803776214, 12566.15169998280),
        (0.00000000420, 0.41925861858, 155.42039943420),
        (0.00000000040, 3.59847585840, 18849.22754997420),
        (0.00000000041, 3.14398414077, 3.52311834900),
        (0.00000000035, 5.00298940826, 5573.14280143310),
        (0.00000000013, 0.48794833701, 77713.77146812050),
        (0.00000000010, 5.64801766350, 6127.65545055720),
        (0.00000000008, 2.84160570605, 161000.68573767410),
        (0.00000000002, 0.54912904658, 6438.49624942560),
    ),
    # all 5
    (
        (0.00000000878, 3.14159265359, 0.00000000000),
        (0.00000000172, 2.76579069510, 6283.07584999140),
        (0.00000000050, 2.01353298182, 155.42039943420),
        (0.00000000028, 2.21496423926, 12566.15169998280),
        (0.00000000005, 1.75600058765, 18849.22754997420),
    ),
)
# B
HELIOCENTRIC_LATITUDE_COEFFS = \
(
    (
        (280.0, 3.199, 84334.662),
        (102.0, 5.422, 5507.553),
        (80.0, 3.88, 5223.69),
        (44.0, 3.7, 2352.87),
        (32.0, 4.0, 1577.34),
    ),
    (
        (9.0, 3.9, 5507.55),
        (6.0, 1.73, 5223.69),
    ),
)

# R
AU_DISTANCE_COEFFS = \
(
    (
        (100013989.0, 0.0, 0.0),
        (1670700.0, 3.0984635, 6283.07585),
        (13956.0, 3.05525, 12566.1517),
        (3084.0, 5.1985, 77713.7715),
        (1628.0, 1.1739, 5753.3849),
        (1576.0, 2.8469, 7860.4194),
        (925.0, 5.453, 11506.77),
        (542.0, 4.564, 3930.21),
        (472.0, 3.661, 5884.927),
        (346.0, 0.964, 5507.553),
        (329.0, 5.9, 5223.694),
        (307.0, 0.299, 5573.143),
        (243.0, 4.273, 11790.629),
        (212.0, 5.847, 1577.344),
        (186.0, 5.022, 10977.079),
        (175.0, 3.012, 18849.228),
        (110.0, 5.055, 5486.778),
        (98.0, 0.89, 6069.78),
        (86.0, 5.69, 15720.84),
        (86.0, 1.27, 161000.69),
        (65.0, 0.27, 17260.15),
        (63.0, 0.92, 529.69),
        (57.0, 2.01, 83996.85),
        (56.0, 5.24, 71430.7),
        (49.0, 3.25, 2544.31),
        (47.0, 2.58, 775.52),
        (45.0, 5.54, 9437.76),
        (43.0, 6.01, 6275.96),
        (39.0, 5.36, 4694.0),
        (38.0, 2.39, 8827.39),
        (37.0, 0.83, 19651.05),
        (37.0, 4.9, 12139.55),
        (36.0, 1.67, 12036.46),
        (35.0, 1.84, 2942.46),
        (33.0, 0.24, 7084.9),
        (32.0, 0.18, 5088.63),
        (32.0, 1.78, 398.15),
        (28.0, 1.21, 6286.6),
        (28.0, 1.9, 6279.55),
        (26.0, 4.59, 10447.39),
    ),
    (
        (103019.0, 1.10749, 6283.07585),
        (1721.0, 1.0644, 12566.1517),
        (702.0, 3.142, 0.0),
        (32.0, 1.02, 18849.23),
        (31.0, 2.84, 5507.55),
        (25.0, 1.32, 5223.69),
        (18.0, 1.42, 1577.34),
        (10.0, 5.91, 10977.08),
        (9.0, 1.42, 6275.96),
        (9.0, 0.27, 5486.78),
    ),
    (
        (4359.0, 5.7846, 6283.0758),
        (124.0, 5.579, 12566.152),
        (12.0, 3.14, 0.0),
        (9.0, 3.63, 77713.77),
        (6.0, 1.87, 5573.14),
        (3.0, 5.47, 18849.23),
    ),
    (
        (145.0, 4.273, 6283.076),
        (7.0, 3.92, 12566.15),
    ),
    (
        (4.0, 2.56, 6283.08),
    ),
)